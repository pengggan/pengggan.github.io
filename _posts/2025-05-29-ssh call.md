---
layout: post
title: "ssh call"
subtitle: "Cloudflare"
author: "Pg"
header-mask: 0.3
tags:
  - ssh
  - call
---

#### 命令
```
检查脚本权限：
ls -l /usr/ssh.sh
查看实时日志：
tail -f /usr/ssh_telegram_alert.log
手动执行脚本测试：
sudo /usr/ssh.sh
手动修改时间戳测试6小时限制：
sudo date -s "5 hours ago" +%s > /usr/ssh_telegram
```
#### ssh.sh
```
cat << 'EOF' > /usr/ssh.sh
#!/bin/bash
TOKEN="7422217982:AAGcyh0Do-RzggL8i61BksdVZModB6wfHzc"
CHAT_ID="7071127210"
LOG_FILE="/usr/ssh_telegram_alert.log"
LOCK_DIR="/usr/ssh_telegram"
LOCK_FILE="${LOCK_DIR}/alert.lock"
ALERT_INTERVAL=21600
GLOBAL_LOCK="/tmp/ssh_alert_global.lock"

# 全局频率限制（1秒内不重复执行）
if [[ -f "$GLOBAL_LOCK" ]]; then
    (( $(date +%s) - $(stat -c %Y "$GLOBAL_LOCK") < 1 )) && exit 0
fi
touch "$GLOBAL_LOCK"

mkdir -p "$LOCK_DIR"
exec 9>"$LOCK_FILE"
flock -n 9 || exit 1

PAM_USER="${PAM_USER:-$USER}"
USER_LOCK_FILE="${LOCK_DIR}/user_${PAM_USER}.lock"

# 异步发送Telegram通知（减少阻塞）
send_alert() {
    CLIENT_IP=${SSH_CLIENT%% *}
    [[ -z "$CLIENT_IP" ]] && CLIENT_IP="未知"
    MESSAGE="🚨 SSH登录告警 🚨
用户: $PAM_USER 
主机: $(hostname)
IP: $CLIENT_IP
时间: $(date '+%Y-%m-%d %H:%M:%S')"
    (/usr/bin/curl -s -X POST -H "Content-Type: application/json" \
     -d "{\"chat_id\":\"$CHAT_ID\",\"text\":\"$MESSAGE\"}" \
     "https://api.telegram.org/bot$TOKEN/sendMessage" >/dev/null 2>&1) &
    touch "$USER_LOCK_FILE"
}

if [[ -f "$USER_LOCK_FILE" ]]; then
    (( $(date +%s) - $(stat -c %Y "$USER_LOCK_FILE") < ALERT_INTERVAL )) && exit 0
fi

send_alert
flock -u 9
rm -f "$GLOBAL_LOCK"
exit 0
EOF
echo "ssh.sh脚本成功:"
cat << 'EOF' >> /etc/pam.d/sshd
session optional pam_exec.so /usr/ssh.sh
EOF
echo "/etc/pam.d/sshd脚本成功:"
sudo apt update && sudo apt install -y curl jq
echo "依赖安装成功:"
sudo chmod +x /usr/ssh.sh
sudo systemctl restart sshd
echo "重启成功:"
```
